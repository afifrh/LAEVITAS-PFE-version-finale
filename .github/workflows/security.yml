name: Security - Analyse et Surveillance

on:
  schedule:
    # ExÃ©cuter tous les jours Ã  2h du matin
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # Job 1: Analyse des dÃ©pendances
  dependency-scan:
    name: ðŸ” Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci
          
      - name: ðŸ” Audit backend dependencies
        run: |
          cd backend
          npm audit --audit-level=moderate --json > ../backend-audit.json || true
          npm audit --audit-level=moderate
          
      - name: ðŸ” Audit frontend dependencies
        run: |
          cd frontend
          npm audit --audit-level=moderate --json > ../frontend-audit.json || true
          npm audit --audit-level=moderate
          
      - name: ðŸ“Š Generate dependency report
        run: |
          echo "# ðŸ“‹ Rapport d'audit des dÃ©pendances" > dependency-report.md
          echo "" >> dependency-report.md
          echo "## Backend" >> dependency-report.md
          echo "\`\`\`json" >> dependency-report.md
          cat backend-audit.json >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Frontend" >> dependency-report.md
          echo "\`\`\`json" >> dependency-report.md
          cat frontend-audit.json >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md
          
      - name: ðŸ“¤ Upload audit results
        uses: actions/upload-artifact@v3
        with:
          name: dependency-audit
          path: |
            backend-audit.json
            frontend-audit.json
            dependency-report.md

  # Job 2: Analyse de code statique
  static-analysis:
    name: ðŸ”¬ Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ”¬ Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=laevitas-trading-platform
            -Dsonar.organization=your-org
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/coverage/**,**/build/**,**/dist/**
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
            
      - name: ðŸ” Run ESLint Security
        run: |
          cd backend
          npx eslint . --ext .js,.ts --format json --output-file ../backend-eslint.json || true
          cd ../frontend
          npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file ../frontend-eslint.json || true
          
      - name: ðŸ“¤ Upload static analysis results
        uses: actions/upload-artifact@v3
        with:
          name: static-analysis
          path: |
            backend-eslint.json
            frontend-eslint.json

  # Job 3: Analyse des secrets
  secret-scan:
    name: ðŸ” Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ” Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
          
      - name: ðŸ” Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml

  # Job 4: Analyse des conteneurs Docker
  container-scan:
    name: ðŸ³ Container Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ðŸ—ï¸ Build images for scanning
        run: |
          docker build -t laevitas-backend:scan ./backend
          docker build -t laevitas-frontend:scan ./frontend
          
      - name: ðŸ” Run Trivy scan on backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'laevitas-backend:scan'
          format: 'sarif'
          output: 'backend-trivy.sarif'
          
      - name: ðŸ” Run Trivy scan on frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'laevitas-frontend:scan'
          format: 'sarif'
          output: 'frontend-trivy.sarif'
          
      - name: ðŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'backend-trivy.sarif'
          
      - name: ðŸ“Š Upload Trivy scan results (frontend)
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'frontend-trivy.sarif'
          
      - name: ðŸ” Run Snyk Container scan
        continue-on-error: true
        run: |
          npm install -g snyk
          snyk auth ${{ secrets.SNYK_TOKEN }}
          snyk container test laevitas-backend:scan --json > backend-snyk.json || true
          snyk container test laevitas-frontend:scan --json > frontend-snyk.json || true
          
      - name: ðŸ“¤ Upload container scan results
        uses: actions/upload-artifact@v3
        with:
          name: container-security
          path: |
            backend-trivy.sarif
            frontend-trivy.sarif
            backend-snyk.json
            frontend-snyk.json

  # Job 5: Tests de pÃ©nÃ©tration automatisÃ©s
  penetration-tests:
    name: ðŸŽ¯ Penetration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸš€ Start application
        run: |
          docker-compose up -d
          sleep 30
          
      - name: ðŸŽ¯ Run OWASP ZAP scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          
      - name: ðŸŽ¯ Run Nuclei scan
        run: |
          docker run --rm --network host \
            -v $(pwd):/workspace \
            projectdiscovery/nuclei:latest \
            -target http://localhost \
            -o /workspace/nuclei-results.txt
            
      - name: ðŸ“Š Generate penetration test report
        run: |
          echo "# ðŸŽ¯ Rapport de tests de pÃ©nÃ©tration" > pentest-report.md
          echo "" >> pentest-report.md
          echo "## OWASP ZAP Results" >> pentest-report.md
          if [ -f report_html.html ]; then
            echo "Voir le fichier report_html.html pour les dÃ©tails" >> pentest-report.md
          fi
          echo "" >> pentest-report.md
          echo "## Nuclei Results" >> pentest-report.md
          if [ -f nuclei-results.txt ]; then
            echo "\`\`\`" >> pentest-report.md
            cat nuclei-results.txt >> pentest-report.md
            echo "\`\`\`" >> pentest-report.md
          fi
          
      - name: ðŸ›‘ Stop application
        if: always()
        run: |
          docker-compose down -v
          
      - name: ðŸ“¤ Upload penetration test results
        uses: actions/upload-artifact@v3
        with:
          name: penetration-tests
          path: |
            report_html.html
            nuclei-results.txt
            pentest-report.md

  # Job 6: Surveillance de la conformitÃ©
  compliance-check:
    name: ðŸ“‹ Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“‹ Check GDPR compliance
        run: |
          echo "VÃ©rification de la conformitÃ© GDPR..."
          # Rechercher des patterns de donnÃ©es personnelles
          grep -r -i "email\|password\|phone\|address" --include="*.js" --include="*.ts" . > gdpr-check.txt || true
          
      - name: ðŸ“‹ Check security headers
        run: |
          echo "VÃ©rification des en-tÃªtes de sÃ©curitÃ©..."
          # VÃ©rifier la prÃ©sence d'en-tÃªtes de sÃ©curitÃ© dans le code
          grep -r -i "helmet\|cors\|csp\|hsts" --include="*.js" --include="*.ts" . > security-headers.txt || true
          
      - name: ðŸ“‹ Check encryption usage
        run: |
          echo "VÃ©rification de l'utilisation du chiffrement..."
          grep -r -i "bcrypt\|crypto\|encrypt\|hash" --include="*.js" --include="*.ts" . > encryption-check.txt || true
          
      - name: ðŸ“Š Generate compliance report
        run: |
          echo "# ðŸ“‹ Rapport de conformitÃ©" > compliance-report.md
          echo "" >> compliance-report.md
          echo "## GDPR - DonnÃ©es personnelles dÃ©tectÃ©es" >> compliance-report.md
          echo "\`\`\`" >> compliance-report.md
          head -20 gdpr-check.txt >> compliance-report.md
          echo "\`\`\`" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "## En-tÃªtes de sÃ©curitÃ©" >> compliance-report.md
          echo "\`\`\`" >> compliance-report.md
          cat security-headers.txt >> compliance-report.md
          echo "\`\`\`" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "## Utilisation du chiffrement" >> compliance-report.md
          echo "\`\`\`" >> compliance-report.md
          head -20 encryption-check.txt >> compliance-report.md
          echo "\`\`\`" >> compliance-report.md
          
      - name: ðŸ“¤ Upload compliance results
        uses: actions/upload-artifact@v3
        with:
          name: compliance-check
          path: |
            gdpr-check.txt
            security-headers.txt
            encryption-check.txt
            compliance-report.md

  # Job 7: Rapport de sÃ©curitÃ© consolidÃ©
  security-report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, static-analysis, secret-scan, container-scan, compliance-check]
    if: always()
    
    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v3
        
      - name: ðŸ“Š Generate consolidated security report
        run: |
          echo "# ðŸ”’ Rapport de sÃ©curitÃ© consolidÃ©" > SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "Date: $(date)" >> SECURITY_REPORT.md
          echo "Commit: ${{ github.sha }}" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "## ðŸ“‹ RÃ©sumÃ© exÃ©cutif" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          # Analyser les rÃ©sultats et gÃ©nÃ©rer un rÃ©sumÃ©
          CRITICAL_ISSUES=0
          HIGH_ISSUES=0
          MEDIUM_ISSUES=0
          LOW_ISSUES=0
          
          echo "- âœ… Analyse des dÃ©pendances: ${{ needs.dependency-scan.result }}" >> SECURITY_REPORT.md
          echo "- âœ… Analyse statique: ${{ needs.static-analysis.result }}" >> SECURITY_REPORT.md
          echo "- âœ… Recherche de secrets: ${{ needs.secret-scan.result }}" >> SECURITY_REPORT.md
          echo "- âœ… Analyse des conteneurs: ${{ needs.container-scan.result }}" >> SECURITY_REPORT.md
          echo "- âœ… VÃ©rification de conformitÃ©: ${{ needs.compliance-check.result }}" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "## ðŸ“Š MÃ©triques de sÃ©curitÃ©" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "| Niveau | Nombre |" >> SECURITY_REPORT.md
          echo "|--------|--------|" >> SECURITY_REPORT.md
          echo "| ðŸ”´ Critique | $CRITICAL_ISSUES |" >> SECURITY_REPORT.md
          echo "| ðŸŸ  Ã‰levÃ© | $HIGH_ISSUES |" >> SECURITY_REPORT.md
          echo "| ðŸŸ¡ Moyen | $MEDIUM_ISSUES |" >> SECURITY_REPORT.md
          echo "| ðŸŸ¢ Faible | $LOW_ISSUES |" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "## ðŸ“ DÃ©tails par catÃ©gorie" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          # Inclure les rapports dÃ©taillÃ©s
          if [ -d "dependency-audit" ]; then
            echo "### ðŸ” Audit des dÃ©pendances" >> SECURITY_REPORT.md
            cat dependency-audit/dependency-report.md >> SECURITY_REPORT.md
            echo "" >> SECURITY_REPORT.md
          fi
          
          if [ -d "compliance-check" ]; then
            echo "### ðŸ“‹ ConformitÃ©" >> SECURITY_REPORT.md
            cat compliance-check/compliance-report.md >> SECURITY_REPORT.md
            echo "" >> SECURITY_REPORT.md
          fi
          
          echo "## ðŸŽ¯ Recommandations" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "1. ðŸ”„ Mettre Ã  jour les dÃ©pendances vulnÃ©rables" >> SECURITY_REPORT.md
          echo "2. ðŸ”’ ImplÃ©menter les en-tÃªtes de sÃ©curitÃ© manquants" >> SECURITY_REPORT.md
          echo "3. ðŸ” RÃ©viser les permissions et accÃ¨s" >> SECURITY_REPORT.md
          echo "4. ðŸ“ Documenter les procÃ©dures de sÃ©curitÃ©" >> SECURITY_REPORT.md
          echo "5. ðŸ§ª Automatiser les tests de sÃ©curitÃ©" >> SECURITY_REPORT.md
          
      - name: ðŸ“¤ Upload consolidated report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: SECURITY_REPORT.md
          
      - name: ðŸ“¢ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('SECURITY_REPORT.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”’ Rapport de sÃ©curitÃ© automatique\n\n${report}`
            });

  # Job 8: Notifications de sÃ©curitÃ©
  security-notifications:
    name: ðŸ“¢ Security Notifications
    runs-on: ubuntu-latest
    needs: [dependency-scan, static-analysis, secret-scan, container-scan, security-report]
    if: always() && (needs.dependency-scan.result == 'failure' || needs.static-analysis.result == 'failure' || needs.secret-scan.result == 'failure' || needs.container-scan.result == 'failure')
    
    steps:
      - name: ðŸš¨ Send security alert
        run: |
          echo "ðŸš¨ ALERTE SÃ‰CURITÃ‰: Des vulnÃ©rabilitÃ©s ont Ã©tÃ© dÃ©tectÃ©es!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "RÃ©sultats:"
          echo "- DÃ©pendances: ${{ needs.dependency-scan.result }}"
          echo "- Analyse statique: ${{ needs.static-analysis.result }}"
          echo "- Secrets: ${{ needs.secret-scan.result }}"
          echo "- Conteneurs: ${{ needs.container-scan.result }}"
          
          # Envoyer des notifications (Slack, email, etc.)
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ðŸš¨ Alerte sÃ©curitÃ© Laevitas: VulnÃ©rabilitÃ©s dÃ©tectÃ©es!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}